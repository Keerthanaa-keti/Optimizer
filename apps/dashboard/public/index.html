<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CreditForge Dashboard</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.7/dist/chart.umd.min.js"></script>
<style>
  :root {
    --bg: #0d1117;
    --surface: #161b22;
    --border: #30363d;
    --text: #e6edf3;
    --text-dim: #b1bac4;
    --accent: #58a6ff;
    --green: #3fb950;
    --yellow: #d29922;
    --orange: #db6d28;
    --red: #f85149;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Text', 'Segoe UI', sans-serif;
    line-height: 1.5;
    padding: 24px;
    max-width: 900px;
    margin: 0 auto;
  }

  .header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 24px;
    padding-bottom: 16px;
    border-bottom: 1px solid var(--border);
  }

  .header h1 {
    font-size: 24px;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .header h1 .logo { font-size: 28px; color: var(--accent); }

  .header-actions {
    display: flex;
    gap: 12px;
    align-items: center;
  }

  .tier-badge {
    background: var(--surface);
    border: 1px solid var(--border);
    color: var(--accent);
    padding: 4px 12px;
    border-radius: 20px;
    font-size: 13px;
    font-weight: 500;
  }

  .btn {
    background: var(--surface);
    border: 1px solid var(--border);
    color: var(--text);
    padding: 6px 14px;
    border-radius: 6px;
    cursor: pointer;
    font-size: 13px;
    transition: border-color 0.2s;
  }

  .btn:hover { border-color: var(--accent); }

  .summary-cards {
    display: grid;
    grid-template-columns: 1fr 1fr 1fr;
    gap: 16px;
    margin-bottom: 24px;
  }

  .card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 20px;
  }

  .card-title {
    font-size: 12px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: var(--text-dim);
    margin-bottom: 8px;
  }

  .card-value {
    font-size: 32px;
    font-weight: 700;
    font-variant-numeric: tabular-nums;
    line-height: 1.1;
  }

  .card-sub {
    font-size: 13px;
    color: var(--text-dim);
    margin-top: 4px;
  }

  .chart-container {
    position: relative;
    height: 280px;
  }

  .chart-container-sm {
    position: relative;
    height: 220px;
  }

  .tip-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-left: 3px solid var(--accent);
    border-radius: 12px;
    padding: 16px 20px;
    margin-bottom: 24px;
  }

  .tip-headline {
    font-size: 14px;
    font-weight: 600;
    color: var(--text);
    margin-bottom: 4px;
  }

  .tip-detail {
    font-size: 13px;
    color: var(--text-dim);
    line-height: 1.5;
  }

  .footer {
    text-align: center;
    color: var(--text-dim);
    font-size: 12px;
    padding-top: 16px;
    border-top: 1px solid var(--border);
  }

  .footer span { color: var(--accent); }

  .value-hero {
    background: linear-gradient(135deg, #161b22 0%, #1a2332 100%);
    border: 1px solid var(--accent);
    border-radius: 12px;
    padding: 24px;
    margin-bottom: 24px;
    text-align: center;
  }

  .value-hero-amount {
    font-size: 42px;
    font-weight: 700;
    color: var(--green);
    line-height: 1.1;
    font-variant-numeric: tabular-nums;
  }

  .value-hero-label {
    font-size: 14px;
    color: var(--text-dim);
    margin-top: 4px;
    margin-bottom: 16px;
  }

  .value-stats {
    display: flex;
    justify-content: center;
    gap: 24px;
    flex-wrap: wrap;
  }

  .value-stat {
    font-size: 13px;
    color: var(--text-dim);
  }

  .value-stat strong {
    color: var(--text);
  }

  .value-week {
    margin-top: 12px;
    padding-top: 12px;
    border-top: 1px solid var(--border);
    font-size: 13px;
    color: var(--text-dim);
  }

  .value-week strong { color: var(--accent); }

  .loading {
    display: flex;
    align-items: center;
    justify-content: center;
    height: 200px;
    color: var(--text-dim);
  }

  .error { color: var(--red); }

  .report-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-left: 3px solid var(--green);
    border-radius: 12px;
    padding: 20px;
    margin-bottom: 24px;
  }

  .report-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 12px;
  }

  .report-header .card-title { margin-bottom: 0; }

  .report-date-select {
    background: var(--bg);
    border: 1px solid var(--border);
    color: var(--text);
    padding: 4px 8px;
    border-radius: 6px;
    font-size: 12px;
  }

  .report-body {
    font-size: 13px;
    line-height: 1.7;
    color: var(--text-dim);
    white-space: pre-wrap;
    font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Text', sans-serif;
  }

  .report-body h1, .report-body h2 {
    color: var(--text);
    font-size: 15px;
    margin: 12px 0 6px;
  }

  .report-body h1 { font-size: 17px; margin-top: 0; }

  .report-projects {
    margin-top: 16px;
    display: flex;
    flex-direction: column;
    gap: 8px;
  }

  .report-project {
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 10px 14px;
  }

  .report-project-info {
    font-size: 12px;
    color: var(--text-dim);
  }

  .report-project-info strong {
    color: var(--text);
  }

  .btn-push {
    background: var(--green);
    border: none;
    color: #fff;
    padding: 6px 14px;
    border-radius: 6px;
    cursor: pointer;
    font-size: 12px;
    font-weight: 600;
    transition: opacity 0.2s;
  }

  .btn-push:hover { opacity: 0.9; }
  .btn-push:disabled { opacity: 0.5; cursor: not-allowed; }
  .btn-push.pushed { background: var(--accent); }

  @media (max-width: 700px) {
    .summary-cards { grid-template-columns: 1fr; }
  }
</style>
</head>
<body>

<div class="header">
  <h1><span class="logo">&#x2692;</span> CreditForge Dashboard</h1>
  <div class="header-actions">
    <span class="tier-badge" id="tier-badge">--</span>
    <button class="btn" onclick="refresh()">Refresh</button>
  </div>
</div>

<div id="content">
  <div class="loading">Loading stats...</div>
</div>

<div class="footer">
  <span>CreditForge</span> &middot; Auto-refresh every 60s
</div>

<script>
Chart.defaults.color = '#e6edf3';
Chart.defaults.borderColor = '#30363d';

function pctColor(pct) {
  if (pct >= 80) return '#f85149';
  if (pct >= 60) return '#db6d28';
  if (pct >= 40) return '#d29922';
  return '#3fb950';
}

let charts = {};

function destroyCharts() {
  for (const c of Object.values(charts)) {
    if (c && c.destroy) c.destroy();
  }
  charts = {};
}

async function refresh() {
  try {
    const [statsRes, reportRes, nightRes] = await Promise.all([
      fetch('/api/stats'),
      fetch('/api/report'),
      fetch('/api/night-stats'),
    ]);
    if (!statsRes.ok) throw new Error('API error');
    const data = await statsRes.json();
    if (data.error) throw new Error(data.error);

    const reportData = reportRes.ok ? await reportRes.json() : null;
    const nightData = nightRes.ok ? await nightRes.json() : null;
    render(data, reportData, nightData);
  } catch (err) {
    document.getElementById('content').innerHTML =
      `<div class="loading error">Failed to load stats: ${err.message}</div>`;
  }
}

function render(data, reportData, nightData) {
  destroyCharts();

  document.getElementById('tier-badge').textContent = data.tierLabel;

  const sub = data.subscription;
  const content = document.getElementById('content');

  // Build value hero card
  let valueHtml = '';
  if (nightData && nightData.valueSaved) {
    const v = nightData.valueSaved;
    const w = nightData.thisWeek;
    const hasData = v.tasksAutomated > 0 || w.tasksRun > 0;
    if (hasData) {
      valueHtml = `
        <div class="value-hero">
          <div class="value-hero-amount">$${v.recoveredDollars.toFixed(2)}</div>
          <div class="value-hero-label">subscription value recovered by CreditForge</div>
          <div class="value-stats">
            <span class="value-stat"><strong>${v.tasksAutomated}</strong> tasks automated</span>
            <span class="value-stat"><strong>${v.hoursRecovered}h</strong> recovered</span>
            <span class="value-stat"><strong>+${v.utilizationBoostPct}%</strong> utilization</span>
          </div>
          ${w.tasksRun > 0 ? `<div class="value-week">This week: <strong>${w.succeeded} tasks</strong> done overnight, <strong>$${(nightData.thisWeek.totalCostCents / 100).toFixed(2)}</strong> invested</div>` : ''}
        </div>
      `;
    } else {
      valueHtml = `
        <div class="value-hero" style="border-color: var(--border)">
          <div class="value-hero-amount" style="color: var(--text-dim)">$0.00</div>
          <div class="value-hero-label">Enable Night Mode to start recovering subscription value</div>
        </div>
      `;
    }
  }

  // Build report HTML if available
  let reportHtml = '';
  if (reportData && reportData.markdown) {
    const mdLines = reportData.markdown.split('\n');
    const renderedMd = mdLines.map(l => {
      if (l.startsWith('# ')) return `<h1>${l.slice(2)}</h1>`;
      if (l.startsWith('## ')) return `<h2>${l.slice(3)}</h2>`;
      if (l.startsWith('- ')) return `<div style="padding-left:12px">${l}</div>`;
      if (l.startsWith('Project: ')) return '';  // Handled in push buttons
      return l ? `<div>${l}</div>` : '<br>';
    }).join('\n');

    const projectButtons = (reportData.projects || []).map(p =>
      `<div class="report-project">
        <div class="report-project-info">
          <strong>${p.path.split('/').pop()}</strong><br>
          <span style="font-family:monospace;font-size:11px">${p.branch}</span>
        </div>
        <button class="btn-push" onclick="pushBranch(this, '${p.path.replace(/'/g, "\\'")}', '${p.branch}')">Push to Remote</button>
      </div>`
    ).join('');

    reportHtml = `
      <div class="report-card">
        <div class="report-header">
          <div class="card-title">Morning Report &mdash; ${reportData.date}</div>
          <select class="report-date-select" id="report-date-select" onchange="loadReport(this.value)"></select>
        </div>
        <div class="report-body">${renderedMd}</div>
        ${projectButtons ? `<div class="report-projects">${projectButtons}</div>` : ''}
      </div>
    `;
  }

  content.innerHTML = `
    ${valueHtml}

    <div class="summary-cards">
      <div class="card">
        <div class="card-title">Used This Week</div>
        <div class="card-value" style="color:${pctColor(sub.weeklyUtilizationPct)}">$${sub.weeklyUsed.toFixed(2)}</div>
        <div class="card-sub">of $${sub.weeklyBudget.toFixed(2)} weekly budget</div>
      </div>
      <div class="card">
        <div class="card-title">Weekly Budget</div>
        <div class="card-value" style="color:var(--accent)">$${sub.weeklyBudget.toFixed(2)}</div>
        <div class="card-sub">$${sub.monthlyUsd}/month plan</div>
      </div>
      <div class="card">
        <div class="card-title">Utilization</div>
        <div class="card-value" style="color:${pctColor(sub.weeklyUtilizationPct)}">${sub.weeklyUtilizationPct}%</div>
        <div class="card-sub">${sub.weeklyUtilizationPct >= 70 ? 'Great usage!' : sub.weeklyUtilizationPct >= 40 ? 'Room to grow' : 'Underutilized'}</div>
      </div>
    </div>

    ${reportHtml}

    <div class="card" style="margin-bottom:24px">
      <div class="card-title">Daily Spend &mdash; Last 7 Days</div>
      <div class="chart-container">
        <canvas id="spendChart"></canvas>
      </div>
    </div>

    <div class="tip-card">
      <div class="tip-headline">${data.tip.headline}</div>
      <div class="tip-detail">${data.tip.detail}</div>
    </div>

    <div class="card">
      <div class="card-title">Usage by Hour</div>
      <div class="chart-container-sm">
        <canvas id="hourChart"></canvas>
      </div>
    </div>
  `;

  // Populate date selector
  if (reportData && reportData.markdown) {
    loadReportDates(reportData.date);
  }

  renderSpendChart(data);
  renderHourChart(data);
}

function renderSpendChart(data) {
  const ctx = document.getElementById('spendChart').getContext('2d');
  const sub = data.subscription;
  const labels = sub.dailySpend.map(d => d.date.slice(5));
  const values = sub.dailySpend.map(d => d.dollars);

  charts.spend = new Chart(ctx, {
    type: 'bar',
    data: {
      labels,
      datasets: [{
        label: 'Daily Spend ($)',
        data: values,
        backgroundColor: values.map(v => {
          const dailyTarget = sub.weeklyBudget / 7;
          if (v > dailyTarget * 1.3) return '#f85149';
          if (v > dailyTarget) return '#d29922';
          return '#58a6ff';
        }),
        borderRadius: 4,
        borderSkipped: false,
      }],
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { display: false },
        tooltip: {
          callbacks: {
            label: (item) => `$${item.raw.toFixed(2)}`,
          },
        },
      },
      scales: {
        x: {
          grid: { display: false },
          ticks: { color: '#c9d1d9', font: { size: 11 } },
        },
        y: {
          grid: { color: '#21262d' },
          ticks: {
            color: '#c9d1d9',
            callback: (v) => '$' + v,
          },
        },
      },
    },
    plugins: [{
      id: 'budgetLine',
      afterDatasetsDraw(chart) {
        const yScale = chart.scales.y;
        const dailyTarget = sub.weeklyBudget / 7;
        if (dailyTarget > yScale.max * 1.5) return;
        const y = yScale.getPixelForValue(dailyTarget);
        const ctx2 = chart.ctx;
        ctx2.save();
        ctx2.setLineDash([6, 4]);
        ctx2.strokeStyle = '#d2992288';
        ctx2.lineWidth = 1.5;
        ctx2.beginPath();
        ctx2.moveTo(chart.chartArea.left, y);
        ctx2.lineTo(chart.chartArea.right, y);
        ctx2.stroke();
        ctx2.fillStyle = '#d29922';
        ctx2.font = '10px sans-serif';
        ctx2.fillText('daily avg', chart.chartArea.right - 50, y - 4);
        ctx2.restore();
      },
    }],
  });
}

function renderHourChart(data) {
  const ctx = document.getElementById('hourChart').getContext('2d');
  const hours = Array.from({ length: 24 }, (_, i) => i);
  const values = hours.map(h => data.hourCounts[String(h)] || 0);
  const maxVal = Math.max(...values, 1);

  charts.hour = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: hours.map(h => String(h).padStart(2, '0')),
      datasets: [{
        data: values,
        backgroundColor: values.map(v =>
          v >= maxVal * 0.8 ? '#f85149' :
          v >= maxVal * 0.5 ? '#d29922' :
          v > 0 ? '#58a6ff' : '#21262d'
        ),
        borderRadius: 2,
      }],
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { display: false },
        tooltip: {
          callbacks: {
            title: (items) => `${items[0].label}:00`,
            label: (item) => `${item.raw} sessions`,
          },
        },
      },
      scales: {
        x: {
          grid: { display: false },
          ticks: { color: '#c9d1d9', font: { size: 10 } },
        },
        y: {
          grid: { color: '#21262d' },
          ticks: { color: '#c9d1d9', stepSize: 1 },
        },
      },
    },
  });
}

async function loadReportDates(currentDate) {
  try {
    const res = await fetch('/api/report/list');
    if (!res.ok) return;
    const { dates } = await res.json();
    const select = document.getElementById('report-date-select');
    if (!select) return;
    select.innerHTML = dates.map(d =>
      `<option value="${d}" ${d === currentDate ? 'selected' : ''}>${d}</option>`
    ).join('');
  } catch { /* ignore */ }
}

async function loadReport(date) {
  try {
    const res = await fetch(`/api/report?date=${date}`);
    if (!res.ok) return;
    const reportData = await res.json();
    // Re-render with updated report
    const statsRes = await fetch('/api/stats');
    const data = await statsRes.json();
    render(data, reportData);
  } catch { /* ignore */ }
}

async function pushBranch(btn, projectPath, branch) {
  if (!confirm(`Push ${branch} from ${projectPath.split('/').pop()} to remote?`)) return;
  btn.disabled = true;
  btn.textContent = 'Pushing...';
  try {
    const res = await fetch('/api/push', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ projectPath, branch }),
    });
    const result = await res.json();
    if (result.success) {
      btn.textContent = 'Pushed';
      btn.classList.add('pushed');
    } else {
      btn.textContent = 'Failed';
      btn.disabled = false;
      setTimeout(() => { btn.textContent = 'Push to Remote'; }, 3000);
    }
  } catch {
    btn.textContent = 'Error';
    btn.disabled = false;
    setTimeout(() => { btn.textContent = 'Push to Remote'; }, 3000);
  }
}

// Initial load
refresh();

// Auto-refresh every 60 seconds
setInterval(refresh, 60 * 1000);
</script>
</body>
</html>
